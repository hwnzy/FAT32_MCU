C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE FAT
OBJECT MODULE PLACED IN FAT.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE FAT.c COMPACT BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "FAT.h"
   2          #include "SD.h"
   3          
   4          #define PRINTF                   Lcd12864PrintfOne               //´òÓ¡         ²ÎÊý£º×Ö·û´®Ö¸Õë
   5          
   6          #define FATFSDEVICERESET        !sd_reset                        //Éè±¸¸´Î»     ÎÞ²Î    ·µ»Ø£ºBOOL ³É¹¦£ºTRUE
   7          #define FATFSDEVICEINITIAL      !sd_init                         //Éè±¸³õÊ¼»¯   ÎÞ²Î    ·µ»Ø£ºBOOL ³É¹¦£ºTRUE
   8          #define FATFSDEVICEREADBLOCK    !sd_read_sector                  //Éè±¸¶Á¿é     ²ÎÊý£ºDWORDÉÈÇøµØÖ·£¬ÉÈÇø»º´æ(512B)     ·µ»Ø£ºBOOL 
             -³É¹¦£ºTRUE
   9          #define FATFSDEVICEWRITEBLOCK   !sd_write_sector                 //Éè±¸Ð´¿é     ²ÎÊý£ºDWORDÉÈÇøµØÖ·£¬ÉÈÇø»º´æ(512B)     ·µ»Ø£ºBOOL
             - ³É¹¦£ºTRUE
  10          
  11          #define BPB_POINT                       BPB_Point
  12          #define BPB_BYTEPERSEC          WORDLE(BPB_POINT[11], BPB_POINT[12])
  13          #define BPB_SECPERCLUS          BYTELE(BPB_POINT[13])
  14          #define BPB_RSVDSECCNT          WORDLE(BPB_POINT[14], BPB_POINT[15])
  15          #define BPB_NUMFATS                     BYTELE(BPB_POINT[16])
  16          #define BPB_ROOTENTCNT          WORDLE(BPB_POINT[17], BPB_POINT[18])
  17          #define BPB_TOTSEC16            WORDLE(BPB_POINT[19], BPB_POINT[20])
  18          #define BPB_MEDIA                       BYTELE(BPB_POINT[21])
  19          #define BPB_FATSZ16                     WORDLE(BPB_POINT[22],BPB_POINT[23])
  20          #define BPB_SECPERTRK           WORDLE(BPB_POINT[24], BPB_POINT[25])
  21          #define BPB_NUMHEADS            WORDLE(BPB_POINT[26], BPB_POINT[27])
  22          #define BPB_HIDDSEC                     DWORDLE(BPB_POINT[28], BPB_POINT[29], BPB_POINT[30], BPB_POINT[31])
  23          #define BPB_TOTSEC32            DWORDLE(BPB_POINT[32], BPB_POINT[33], BPB_POINT[34], BPB_POINT[35])
  24          //FAT 32
  25          #define BPB_FATSZ32                     DWORDLE(BPB_POINT[36], BPB_POINT[37], BPB_POINT[38], BPB_POINT[39])
  26          #define BPB_EXTFLAGS            WORDLE(BPB_POINT[40], BPB_POINT[41])
  27          #define BPB_FSVER                       WORDLE(BPB_POINT[42], BPB_POINT[43])
  28          #define BPB_ROOTCLUS            DWORDLE(BPB_POINT[44], BPB_POINT[45], BPB_POINT[46], BPB_POINT[47])
  29          #define BPB_FSINFO                      WORDLE(BPB_POINT[48], BPB_POINT[49])
  30          #define BPB_BKBOOTSEC           WORDLE(BPB_POINT[50], BPB_POINT[51])
  31          //FSInfo
  32          #define FSI_POINT                       FSI_Point
  33          #define FSI_LEADSIG                     DWORDLE(FSI_POINT[0], FSI_POINT[1], FSI_POINT[2], FSI_POINT[3])
  34          #define FSI_STRUCSIG            DWORDLE(FSI_POINT[4], FSI_POINT[5], FSI_POINT[6], FSI_POINT[7])
  35          #define FSI_FREE_COUNT          DWORDLE(FSI_POINT[488], FSI_POINT[489], FSI_POINT[490], FSI_POINT[491])
  36          #define FSI_NXT_FREE            DWORDLE(FSI_POINT[492], FSI_POINT[493], FSI_POINT[494], FSI_POINT[495])
  37          
  38          //BPBSec
  39          #define BPB_SEC             DWORDLE(BPB_POINT[454], BPB_POINT[455], BPB_POINT[456], BPB_POINT[457]);
  40          
  41          #define SHORTNAMELENCACHELEN 13                  //ÃüÃû¿Õ¼ä´óÐ¡
  42          #define FAT16MAXPERCHECKCLUS 4                   //FAT16×î´óÔ¤´¦Àí´Ø
  43          #define FAT32MAXPERCHECKCLUS 4                   //FAT32×î´óÔ¤´¦Àí´Ø
  44          #define UNDWORD union dword
  45          
  46          sbit TPIN = P1^0;
  47          
  48          
  49          
  50          struct Byte4 {
  51                  BYTE a;
  52                  BYTE b;
  53                  BYTE c;
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 2   

  54                  BYTE d;
  55          };
  56          
  57          struct Word2 {
  58                  WORD a;
  59                  WORD b;
  60          };
  61          
  62          union dword {
  63                  DWORD Data;
  64                  struct Word2 word;
  65                  struct Byte4 byte;
  66          };
  67          
  68          struct FATFSTemp13 {
  69                  union dword dworda;
  70                  union dword dwordb;
  71                  WORD worda;
  72                  WORD wordb;
  73                  BYTE bytea;
  74          };
  75          
  76          union FATFSStringDataUnion {
  77                  struct FATFSTemp13 Data;        
  78                  BYTE String[SHORTNAMELENCACHELEN];
  79          };
  80          
  81          #define g_wBytePerSec 512
  82          #ifndef g_wBytePerSec                                   //ÔÝÊ±Ö»Ö§³Ö512byte/ÉÈÇøµÄ´¢´æ½éÖÊ
              WORD  data g_wBytePerSec;
              #endif
  85          
  86          union FATFSStringDataUnion g_unTemp;                                              
  87          #define g_szFileShortName g_unTemp.String               //ÃüÃû¿Õ¼ä¸´ÓÃ
  88          #ifndef g_szFileShortName
              BYTE  data g_szFileShortName[SHORTNAMELENCACHELEN];
              #endif
  91          
  92          BOOL  g_IsFATFS = FALSE;
  93          BOOL  g_IsFAT16 = TRUE;
  94          DWORD data g_dwFileFirstClus;
  95          UNDWORD data g_dwFileCurrentClus;
  96          DWORD data g_dwFileSize;
  97          UNDWORD data g_dwFileCurrentSec;
  98          DWORD data g_dwTotalClus;
  99          BYTE  data g_bFileAttrib;
 100          WORD  data g_wRsvdSecCnt;
 101          BYTE  data g_bSecPerClus;
 102          BYTE  data g_bSecPerClusBin;
 103          DWORD data g_dwFirstRootDirNum;
 104          DWORD data g_dwFirstDataSector;
 105          BYTE  data g_bNextBlock;
 106          DWORD data g_dwFATSz;
 107          DWORD data g_dHddsec;
 108          #ifdef _FATFSWRITE_
              BYTE  data g_bNumFATs;
              WORD  data g_wFSInfoNxtFree;    //FAT32ÓÃ×÷ FSInfoÖ¸Õë FAT16ÓÃ×÷×îºó¿ÕÉÈÇøËÑË÷
              #endif
 112          
 113          /*************************************************************************
 114          º¯Êý£ºAnalysisMBR
 115          ÃèÊö£º·ÖÎöMBR£¬ÕÒ³öBPBµÄÎïÀíµØÖ·
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 3   

 116          *************************************************************************/
 117          WORD AnalysisMBR(LPBYTE BPB_POINT)
 118          {
 119   1              if(FATFSDEVICEREADBLOCK(0, BPB_POINT)){
 120   2                      return BPB_SEC;
 121   2              }else{
 122   2                      g_IsFATFS = FALSE;
 123   2                      RETURN(FATFS_READ_BPB_SEC_ERROR);
 124   2              }       
 125   1      }
 126          
 127          
 128          /*************************************************************************
 129           º¯Êý£ºFATFSShortName
 130           ÃèÊö£º8.3ÎÄ¼þÃû×ª»»    
 131          *************************************************************************/
 132          BYTE FATFSShortName(BYTE NameLen){
 133   1              BYTE ExtLen;
 134   1              BYTE Cache[3]={0x20,0x20,0x20}; //ASCIIÂëÖµ´ú±í¿Õ¸ñ
 135   1              for(NameLen=0;g_szFileShortName[NameLen]!='.'&&g_szFileShortName[NameLen]!='\0';++NameLen); //Í£ÔÚ'.'µÄÎ»
             -ÖÃ
 136   1              if(g_szFileShortName[NameLen]!='\0'){ 
 137   2                      ++NameLen;
 138   2                      for(ExtLen=0;g_szFileShortName[NameLen + ExtLen]!='\0';++ExtLen){
 139   3                                      Cache[ExtLen] = g_szFileShortName[NameLen + ExtLen];
 140   3                      }
 141   2                      --NameLen;//»Øµ½'.'µÄÎ»ÖÃ
 142   2              }
 143   1              if(NameLen<9){
 144   2                      for(;NameLen<11;++NameLen){
 145   3                              g_szFileShortName[NameLen] = ' ';
 146   3                      }
 147   2                      NameLen = 8;
 148   2                      for(;NameLen<11;++NameLen){
 149   3                              g_szFileShortName[NameLen] = Cache[NameLen-8]; //²åÈëºó×ºÃû
 150   3                      }
 151   2                      g_szFileShortName[11] = '\0';  //ÔÙ´Î²åÈë×Ö·û´®½áÊø±êÖ¾
 152   2                      RETURN(FATFS_OPERATION_SUCCESS);
 153   2              }else{
 154   2                      RETURN(FATFS_NAME_NAME_TOO_LONG);
 155   2              }
 156   1      }
 157          
 158          /*************************************************************************
 159           º¯Êý£º InitialFATFS
 160           ÃèÊö£º ³õÊ¼»¯FATFS²¢»ñµÃ¸ÃFATÐÅÏ¢
 161          *************************************************************************/
 162          BYTE FATFSInitial(LPBYTE BPB_POINT){                                                             //g_dwTotalClus ×÷ÁÙÊ±±äÁ¿
 163   1              if(FATFSDEVICERESET()){
 164   2                      if(FATFSDEVICEINITIAL()){
 165   3                              if(FATFSDEVICEREADBLOCK(AnalysisMBR(BPB_POINT), BPB_POINT)){ 
 166   4                              //if(FATFSDEVICEREADBLOCK(8192, BPB_POINT)){                            //»ñµÃ0ÉÈÇøÉÏµÄBPBÖ»Ö§³ÖÒ»¸ö·ÖÇøÁË²»È»Òª·ÖÎöMBR
 167   4                                      if(BPB_POINT[510]!=0x55 && BPB_POINT[510]!=0xAA){               //AA55ºÍ55AA¶¼¿ÉÒÔ£¬AA55Ò»°ãÎªÓ²ÅÌÖ÷Òýµ¼ÉÈÇøÄ©Î²
 168   5                                              g_IsFATFS = FALSE;
 169   5                                              RETURN(FATFS_FS_NOT_SUPPORT);
 170   5                                      }
 171   4                                      g_dHddsec = BPB_HIDDSEC; //Òþ²ØÉÈÇøÊý
 172   4                                      g_wRsvdSecCnt = BPB_RSVDSECCNT; //±£ÁôÉÈÇøÊý
 173   4                                      g_dwFATSz = BPB_FATSZ32; //FAT±íËùÕ¼ÉÈÇøÊý
 174   4                                      g_dwFirstDataSector = g_wRsvdSecCnt + BPB_NUMFATS * g_dwFATSz + g_dwTotalClus + g_dHddsec; //Êý¾ÝÇøµÚÒ
             -»¸öÉÈÇø£¬¼ÇµÃ¼ÓÉÏÒþ²ØÉÈÇøÊý
 175   4                                      g_dwTotalClus = BPB_TOTSEC32 - g_dwFirstDataSector + g_dHddsec; //´ÓBPBÖÐ»ñµÃµÄ×ÜÉÈÇøÊý°üÀ¨Òþ²ØÉÈÇøÊý
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 4   

 176   4                                      g_bSecPerClus = BPB_SECPERCLUS; //Ã¿´ØÉÈÇøÊý
 177   4                                      g_dwTotalClus = (g_dwTotalClus + (g_bSecPerClus/2)) / g_bSecPerClus; //Êý¾ÝÇø´ØÊý = Êý¾ÝÉÈÇøÊý / Ã¿´ØÉ
             -ÈÇøÊý
 178   4                                      if(g_dwTotalClus > 65525UL){
 179   5                                              g_dwFirstRootDirNum = BPB_ROOTCLUS;     //FAT32ÌØÓÐ£¬¸ùÄ¿Â¼ËùÔÚµÚÒ»¸ö´Ø´ØºÅ£¬Í¨³£Îª2
 180   5                                              g_IsFAT16 = FALSE;
 181   5                                      }else{
 182   5                                              g_IsFATFS = FALSE;
 183   5                                              RETURN(FATFS_FATFS_NOT_SUPPORT);
 184   5                                      }
 185   4      #ifndef g_wBytePerSec    
                                              g_wBytePerSec = BPB_BYTEPERSEC;
              #else                   //ÔÝÊ±Ö»Ö§³Ö512byte/ÉÈÇøµÄ´¢´æ½éÖÊ
 188   4                                      if(g_wBytePerSec != BPB_BYTEPERSEC){
 189   5                                              RETURN(FATFS_FATFS_NOT_SUPPORT);
 190   5                                      }
 191   4      #endif                          
 192   4                                      g_bSecPerClusBin = 0; //È¡¶þµÄÃÝ
 193   4                                      while(g_bSecPerClus > 1){
 194   5                                               ++g_bSecPerClusBin;
 195   5                                               g_bSecPerClus >>= 1;  //Ã¿´ØÉÈÇøÊý/2
 196   5                                      }
 197   4                                      g_dwFileFirstClus = g_dwFirstRootDirNum; //ÎÄ¼þ¿ªÊ¼´Ø = ¸ùÄ¿Â¼ËùÔÚÊ×´Ø / ÉÈÇøºÅ
 198   4                                      g_bSecPerClus = BPB_SECPERCLUS; //ÖµÒÑ±»¸ü¸Ä£¬ËùÒÔÖØÐÂ¸³Öµ
 199   4                                      g_bNextBlock = 0; //ÏÂÒ»¿éÒª¶ÁµÄÉÈÇø
 200   4                                      g_IsFATFS = TRUE; //ÅÐ¶ÏÎªFAT32ÏµÍ³
 201   4                                      RETURN(FATFS_OPERATION_SUCCESS);
 202   4                              }else{
 203   4                                      g_IsFATFS = FALSE;
 204   4                                      RETURN(FATFS_READ_BPB_SEC_ERROR);
 205   4                              }
 206   3                      }else{
 207   3                              g_IsFATFS = FALSE;
 208   3                              RETURN(FATFS_DEVICE_INITIAL_ERROR);
 209   3                      }
 210   2              }else{ 
 211   2                      g_IsFATFS = FALSE;
 212   2                      RETURN(FATFS_DEVICE_RESET_ERROR);
 213   2              }
 214   1      }
 215          
 216          /*************************************************************************
 217           º¯Êý£º FATFSReadNextBlock
 218           ÃèÊö£º °´Ë³Ðò¶Á³ö´ØÁ´ÉÏµÄÉÈÇø
 219          *************************************************************************/
 220          BYTE FATFSReadNextBlock(LPBYTE FileCache, LPWORD BlockLen){
 221   1              if(g_bNextBlock>=g_bSecPerClus){ //ÒÑ¾­¶ÁµÄÉÈÇøÊý>=Ã¿´ØÉÈÇøÊý
 222   2                      //Ìøµ½ÏÂÒ»¸ö´Ø
 223   2                              //FAT32
 224   2                              if(g_unTemp.Data.bytea == 0){   //²»ÊÇÁ¬ÐøµÄ´ØÁ´
 225   3                                      g_dwFileCurrentClus.Data<<=2;  //¶ÔFAT32¶øÑÔ£¬Ã¿¸ö´ØÕ¼¾Ý4¸ö×Ö½Ú
 226   3                                      g_unTemp.Data.dworda.Data = (g_dwFileCurrentClus.Data / g_wBytePerSec) + g_wRsvdSecCnt + g_dHddsec;//¸
             -ÃÎÄ¼þËùÔÚµÄFATÉÈÇøÊý£¬¼ÓÉÏÒþ²ØÉÈÇø
 227   3                                      if(!FATFSDEVICEREADBLOCK(g_unTemp.Data.dworda.Data, FileCache)){ //¶ÔÏàÓ¦µÄFATÉÈÇø½øÐÐ¶Á¿é
 228   4                                              *BlockLen = 0; //³¤¶ÈÎª0
 229   4                                              RETURN(FATFS_READ_FAT_ERROR); //·µ»Ø¶ÁÈ¡FAT±íÊ§°Ü
 230   4                                      }
 231   3                                      g_unTemp.Data.worda = g_dwFileCurrentClus.Data%g_wBytePerSec; //ÎÄ¼þËùÔÚFAT±íµÄ±íÏîÊý
 232   3                                      g_dwFileCurrentClus.byte.a = FileCache[g_unTemp.Data.worda+3];  //»ñÈ¡ÎÄ¼þÏÂÒ»´Ø´ØºÅ    C51:´ó¶Ë
 233   3                                      g_dwFileCurrentClus.byte.b = FileCache[g_unTemp.Data.worda+2];  //»ñÈ¡ÎÄ¼þÏÂÒ»´Ø´ØºÅ    X86:Ð¡¶Ë
 234   3                                      g_dwFileCurrentClus.byte.c = FileCache[g_unTemp.Data.worda+1];  //»ñÈ¡ÎÄ¼þÏÂÒ»´Ø´ØºÅ
 235   3                                      g_dwFileCurrentClus.byte.d = FileCache[g_unTemp.Data.worda];    //»ñÈ¡ÎÄ¼þÏÂÒ»´Ø´ØºÅ
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 5   

 236   3                                      g_unTemp.Data.dwordb.Data = g_dwFileCurrentClus.Data;  //µÃµ½ÎÄ¼þÏÂÒ»´Ø´ØºÅ
 237   3                                      while(g_unTemp.Data.bytea < FAT32MAXPERCHECKCLUS){         //FATFS×î´óÔ¤´¦Àí´Ø
 238   4                                              g_dwFileCurrentSec.Data = g_unTemp.Data.dwordb.Data << 2;  //ÎÄ¼þÏÂÒ»´ØºÅ X Ã¿´ØºÅÕ¼¾Ý4×Ö½Ú
 239   4                                              if(g_unTemp.Data.dworda.Data == ((g_dwFileCurrentSec.Data / g_wBytePerSec) + g_wRsvdSecCnt)){  //Èç¹û
             -ÎÄ¼þµÄÏÂÒ»´ØµÄFAT±íÏîÊý»¹ÔÚÔ­À´µÄÉÈÇøÄÚ 
 240   5                                                      g_unTemp.Data.worda = g_dwFileCurrentSec.Data % g_wBytePerSec; //»ñÈ¡±íÏîÊý
 241   5                                                      g_dwFileCurrentSec.byte.a = FileCache[g_unTemp.Data.worda+3];  //»ñÈ¡ÎÄ¼þÏÂÏÂÒ»´Ø´ØºÅ
 242   5                                                      g_dwFileCurrentSec.byte.b = FileCache[g_unTemp.Data.worda+2];  //»ñÈ¡ÎÄ¼þÏÂÏÂÒ»´Ø´ØºÅ
 243   5                                                      g_dwFileCurrentSec.byte.c = FileCache[g_unTemp.Data.worda+1];  //»ñÈ¡ÎÄ¼þÏÂÏÂÒ»´Ø´ØºÅ
 244   5                                                      g_dwFileCurrentSec.byte.d = FileCache[g_unTemp.Data.worda];        //»ñÈ¡ÎÄ¼þÏÂÏÂÒ»´Ø´ØºÅ
 245   5                                                      if(g_dwFileCurrentSec.Data == g_unTemp.Data.dwordb.Data + 1){ //Èç¹ûÏÂÏÂÒ»´Ø¸ÕºÃ½Ó×ÅÏÂÒ»´Ø
 246   6                                                              g_unTemp.Data.bytea++;
 247   6                                                              g_unTemp.Data.dwordb.Data = g_dwFileCurrentSec.Data;  //ÏÂÒ»´Ø¶¨ÒåÎªÏÂÏÂÒ»´Ø
 248   6                                                      }else{
 249   6                                                              break;
 250   6                                                      }
 251   5                                              }else{
 252   5                                                      break;
 253   5                                              }
 254   4                                      }
 255   3                                      if((g_dwFileCurrentClus.Data&=0x0FFFFFFFUL) > 0x0FFFFFEFUL){ //ÆðÊ¼´Ø£¨ÃûÒåÉÏ£©»òÁ¬Ðø´ØµÄÊ×´Ø   ¡¾±¸×¢1¡
             -¿£º¼ûÄ©Î²
 256   4                                              *BlockLen = 0;                                    //±£Áô´Ø »µ´Ø ÎÄ¼þÍê
 257   4                                              if(g_dwFileCurrentClus.Data < 0x0FFFFFF6UL){
 258   5                                                      RETURN(FATFS_RETAINED_CLUSTER); //±£Áô´Ø
 259   5                                              }else if(g_dwFileCurrentClus.Data == 0x0FFFFFF7UL){
 260   5                                                      RETURN(FATFS_BAD_CLUSTER); //»µ´Ø
 261   5                                              }else{
 262   5                                                      RETURN(FATFS_LAST_CLUSTER); //×îºóÒ»´Ø
 263   5                                              }
 264   4                                      }
 265   3                              }else{ //ÊÇÁ¬ÐøµÄ´ØÁ´
 266   3                                      g_dwFileCurrentClus.Data++; //ÎÄ¼þÆðÊ¼£¨±ä»¯£©´ØºÅ   ½Ó×ÅÏÂÒ»´Ø
 267   3                                      g_unTemp.Data.bytea--; //Á¬Ðø´ØÊý¼õ1
 268   3                              }       
 269   2                      g_dwFileCurrentSec.Data = ((g_dwFileCurrentClus.Data - 2)<<g_bSecPerClusBin) + g_dwFirstDataSector;     //¸ü
             -ÐÂÎÄ¼þÆðÊ¼ÉÈÇøºÅ
 270   2                      g_bNextBlock = 0; //ÒÑ¾­¶ÁµÄÉÈÇøÊý = 0
 271   2              }
 272   1      
 273   1              //µ±Ç°´Ø
 274   1              if(g_bNextBlock<g_bSecPerClus){ //Èç¹ûÒª¶ÁµÄÉÈÇøÊý < Ã¿´ØÉÈÇøÊý
 275   2                      if(BlockLen){    //¶Ô³£Á¿¶øÑÔ£¬µØÖ·Îª0
 276   3                              if(g_dwFileSize){ //ÎÄ¼þ´óÐ¡²»Îª0
 277   4                                      if(g_dwFileSize >= g_wBytePerSec){  //ÎÄ¼þ´óÐ¡ >= Ã¿ÉÈÇøµÄ×Ö½ÚÊý
 278   5                                              *BlockLen = g_wBytePerSec;              //Êµ¼Ê¶Á³ö³¤¶È = Ã¿ÉÈÇøµÄ×Ö½ÚÊý
 279   5                                              g_dwFileSize -= g_wBytePerSec;  //ÎÄ¼þ´óÐ¡¼õÉÙÒ»¸öÉÈÇø
 280   5                                      }else{
 281   5                                              *BlockLen = g_dwFileSize;  //Êµ¼Ê¶Á³ö³¤¶È = ÎÄ¼þ´óÐ¡
 282   5                                              g_dwFileSize = 0; //ÎÄ¼þ´óÐ¡¸üÐÂÎª0
 283   5                                      }
 284   4                              }else{
 285   4                                      *BlockLen = 0; //Êµ¼Ê¶Á³öµÄ³¤¶ÈÎª0
 286   4                                      RETURN(FATFS_END_OF_FILE);      //·µ»ØÎÄ¼þ½áÊø
 287   4                              }
 288   3                      }
 289   2                      if(!FATFSDEVICEREADBLOCK(g_dwFileCurrentSec.Data, FileCache)){  //Èç¹û¶ÔÎÄ¼þÆðÊ¼£¨±ä»¯£©¶Á¿é²»³É¹¦
 290   3                              *BlockLen = 0;   //Êµ¼Ê³¤¶ÈÎª0
 291   3                              RETURN(FATFS_READ_SEC_ERROR); //·µ»Ø¶ÁÉÈÇøÊ§°Ü
 292   3                      }
 293   2                      ++g_dwFileCurrentSec.Data;      //¼Ó1ÎªÎÄ¼þÏÂÒ»¸öÉÈÇø
 294   2                      ++g_bNextBlock; //ÒÑ¾­¶ÁµÄÉÈÇø¼Ó1
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 6   

 295   2                      RETURN(FATFS_OPERATION_SUCCESS);  //·µ»Ø²Ù×÷³É¹¦
 296   2              }else{
 297   2                      RETURN(FATFS_READ_BLOCK_OVERRANG);      //ÒÑ¾­Íê³É¶Á¿é
 298   2              }               
 299   1      }
 300          
 301          /*************************************************************************
 302           º¯Êý£º FATFSMatchAttrib
 303           ÃèÊö£º È·ÈÏÄ¿Â¼µÄÄÚÈÝ
 304          *************************************************************************/
 305          BYTE FATFSValidateAttrib(BYTE Attr){
 306   1              if((Attr&ATTR_LONG_NAME_MASK)==ATTR_LONG_NAME){
 307   2                      return ATTR_LONG_NAME;
 308   2              }else{
 309   2                      if((Attr&(ATTR_DIRECTORY|ATTR_VOLUME_ID))==0x00){
 310   3                              //ÎÄ¼þ
 311   3                              return ATTR_FILE;
 312   3                      }else if((Attr&(ATTR_DIRECTORY|ATTR_VOLUME_ID))==ATTR_DIRECTORY){
 313   3                              //Ä¿Â¼
 314   3                              return ATTR_DIRECTORY;
 315   3                      }else if((Attr&(ATTR_DIRECTORY|ATTR_VOLUME_ID))==ATTR_VOLUME_ID){
 316   3                              //¾í±ê
 317   3                              return ATTR_VOLUME_ID;
 318   3                      }else{
 319   3                              //Ê²Ã´¶¼²»ÊÇ[ÔÝÇÒ¾ÍÊ¶±ðÕâ¼¸¸öÎÄ¼þÊôÐÔ]
 320   3                              return ATTR_NOTHING;
 321   3                      }
 322   2              }
 323   1      }
 324          
 325          /*************************************************************************
 326           º¯Êý£º FATFSMatchDir 
 327           ÃèÊö£º Æ¥ÅäFATÄ¿Â¼ÏîÖÐµÄÃû³Æ²¢¶ÁÈ¡ÓÐ¹ØÊý¾Ý
 328          *************************************************************************/
 329          BYTE FATFSMatchDir(LPBYTE DirCache, BOOL IsFile){
 330   1              WORD j;
 331   1              BYTE k;
 332   1              for(j=0;j<g_wBytePerSec;j+=32){ //Ã¿¸öÉÈÇø×Ö½ÚÊý£¬Ã¿¸öÄ¿Â¼ÏîµÄ´óÐ¡Îª32×Ö½Ú
 333   2                      if(DirCache[j] == 0xE5){        //ËµÃ÷¸ÃÄ¿Â¼Ïî±»Ê¹ÓÃ¹ý£¬µ«ÒÑ±»É¾³ý
 334   3                              continue;       //¼ÌÐø²éÕÒ
 335   3                      }
 336   2                      if(DirCache[j] == 0x00){        //ËµÃ÷¸ÃÄ¿Â¼Ïî´ÓÎ´±»Ê¹ÓÃ¹ý£¬ÓÉÓÚÄ¿Â¼ÏîµÄ·ÖÅäÊÇ°´Ë³Ðò£¬¹ÊËµÃ÷´ÓÕâ¿ªÊ¼ºóÃæ¶¼Îª0X0
             -0
 337   3                              RETURN(FATFS_END_OF_FATDIR);
 338   3                      }
 339   2                      for(k=0;k<11;++k){
 340   3                              if(DirCache[j+k] == g_szFileShortName[k]){  //½«¸ÃÄ¿Â¼ÏîµÄÇ°11¸öASCIIÂëÓëÊý×é½øÐÐ¶Ô±È
 341   4                                      continue;  //¼ÌÐø±È½ÏÆäÓà×Ö·û
 342   4                              }else{
 343   4                                      break; //Ìø³ö
 344   4                              }
 345   3                      }
 346   2                      if(k==11){
 347   3                              g_bFileAttrib = BYTELE(DirCache[j+11]);  //ÎÄ¼þÊôÐÔ      0x01-ÎÄ¼þ 0x01-Ö»¶Á 0x02-Òþ²Ø 0x04-ÏµÍ³ÎÄ¼þ 0x08-¾
             -í±ê 0x0f-±íÊ¾¸ÃÄ¿Â¼ÏîÎª³¤ÎÄ¼þÃûÄ¿Â¼Ïî 0x10-Ä¿Â¼ 0x20-´æµµ                                                                                                     
 348   3                              if(IsFile){     //ÎÄ¼þ                                                                                                                                                          
 349   4                                      if(FATFSValidateAttrib(g_bFileAttrib)!=ATTR_FILE){ //²é¿´ÊÇ²»ÊÇÎÄ¼þ
 350   5                                              RETURN(FATFS_FILE_NOT_FOUND);
 351   5                                      }
 352   4                              }else{
 353   4                                      if(FATFSValidateAttrib(g_bFileAttrib)!=ATTR_DIRECTORY){//²é¿´ÊÇ²»ÊÇÄ¿Â¼
 354   5                                              RETURN(FATFS_DIRECTORY_NOT_FOUND);
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 7   

 355   5                                      }
 356   4                              }
 357   3                              g_dwFileFirstClus = DWORDLE(DirCache[j+26], DirCache[j+27], DirCache[j+20], DirCache[j+21]); //ÎÄ¼þ¿ªÊ¼
             -´Ø
 358   3                              g_dwFileSize = DWORDLE(DirCache[j+28], DirCache[j+29], DirCache[j+30], DirCache[j+31]); //ÎÄ¼þÄÚÈÝ´óÐ¡×
             -Ö½ÚÊý
 359   3                              RETURN(FATFS_OPERATION_SUCCESS);
 360   3                      }
 361   2              }
 362   1              RETURN(FATFS_CACHE_NOMATCH);  
 363   1      }
 364          
 365          
 366          /*************************************************************************
 367           º¯Êý£º FATFSOpenDir
 368           ÃèÊö£º ´ò¿ªµ±Ç°Ä¿Â¼ ²¢Æ¥Åä¸ÃÄ¿Â¼µÄÎÄ¼þ
 369          *************************************************************************/
 370          BYTE FATFSDirOperation(LPBYTE DataCache, BOOL IsFile){
 371   1              BYTE k;
 372   1              do{     //Ö»Ö´ÐÐÒ»´ÎµÄ¡°Ñ­»·¡± ×îÓÅ»¯´úÂë
 373   2                      if(g_dwFileFirstClus == g_dwFirstRootDirNum){ //Èç¹ûÊÇ¸ùÄ¿Â¼
 374   3                                      g_dwFileCurrentClus.Data = g_dwFirstRootDirNum; //FAT32¸ùÄ¿Â¼Ïî±íµ±ÎÄ¼þ´ò¿ª£¬¸³Öµ¸ùÄ¿Â¼ËùÔÚµÄ´ØºÅ
 375   3                      }else{ //²»ÊÇ¸ùÄ¿Â¼
 376   3                              g_dwFileCurrentClus.Data =      g_dwFileFirstClus; 
 377   3                      }
 378   2                      g_dwFileCurrentSec.Data = ((g_dwFileCurrentClus.Data - 2)<<g_bSecPerClusBin) + g_dwFirstDataSector;      //Î
             -Ä¼þ¿ªÊ¼ÉÈÇøºÅ£¨¼õ2ÊÇÒòÎªFAT32ÊÇ´Ó2¿ªÊ¼µÄ£©
 379   2                      g_bNextBlock = 0; //Òª¶ÁµÄÉÈÇø¿éÎª0
 380   2                      while(FATFSReadNextBlock(DataCache,0)==FATFS_OPERATION_SUCCESS){  //°´Ë³Ðò¶Á³ö´ØÁ´ÉÏµÄÉÈÇø£¬¶ÁÒ»¿é
 381   3                              k = FATFSMatchDir(DataCache, IsFile); //½«¶Áµ½µÄÊý¾ÝÓëÊý×é½øÐÐ±È½Ï£¬½øÐÐÆ¥Åä²éÕÒ
 382   3                              if(k == FATFS_CACHE_NOMATCH){  //Ã»ÓÐÕÒµ½
 383   4                                      continue; //ÔÙ´ÎÑ­»·
 384   4                              }else{
 385   4                                      break; //Ìø³öÑ­»·
 386   4                              }
 387   3                      }
 388   2              }while(0);
 389   1              if(k != FATFS_OPERATION_SUCCESS){ //Èç¹ûÃ»ÓÐÆ¥Åä³É¹¦
 390   2                      if(IsFile){     //ÊÇÎÄ¼þ
 391   3                              RETURN(FATFS_FILE_NOT_FOUND);
 392   3                      }else{ //ÊÇÎÄ¼þ¼Ð£¨Ä¿Â¼£©
 393   3                              RETURN(FATFS_DIRECTORY_NOT_FOUND);
 394   3                      }
 395   2              }
 396   1              g_dwFileCurrentClus.Data = g_dwFileFirstClus; //ÎÄ¼þÊý¾Ý¿ªÊ¼´Ø
 397   1              g_dwFileCurrentSec.Data = ((g_dwFileCurrentClus.Data - 2)<<g_bSecPerClusBin) + g_dwFirstDataSector;     //ÎÄ¼
             -þÆðÊ¼ÉÈÇøºÅ
 398   1              g_bNextBlock = 0; //Òª¶ÁµÄÉÈÇøÊý
 399   1              g_unTemp.Data.bytea = 0; //´ØÁ´µÄÁ¬Ðø´ØÊýÎª0
 400   1              RETURN(FATFS_OPERATION_SUCCESS);
 401   1      }
 402          
 403          /*************************************************************************
 404           º¯Êý£º FATFSOpen
 405           ÃèÊö£º ´ò¿ªÖ¸¶¨Â·¾¶µÄFATÎÄ¼þ
 406          *************************************************************************/
 407          BYTE FATFSOpen(LPBYTE DataCache, LPBYTE szPath){
 408   1      //e.g.  "\ABC\DEF\BAD.BIN" "ABC\DEF\BAD.BIN" "\BAD.BIN" "BAD.BIN"
 409   1              BYTE i;
 410   1              if(g_IsFATFS){
 411   2                      i = 0;
 412   2                      if(szPath[0] == '\\'){  //²é¿´Ä¿±êÂ·¾¶µÄÊ××Ö·ûÊÇ·ñÊÇ'\'
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 8   

 413   3                              szPath += 1; //Ìø¹ý'\'
 414   3                      }
 415   2                      while(1){
 416   3                              szPath = szPath + i;
 417   3                              for(i=0;szPath[i]!='\0'&&szPath[i]!='\\'&&i<SHORTNAMELENCACHELEN-1;++i){ //½«Ãû³Æ×ªÒÆÖÁÊý×ég_szFileShor
             -tName
 418   4                                      g_szFileShortName[i] = szPath[i];
 419   4                              }
 420   3                              if(i==SHORTNAMELENCACHELEN-1){
 421   4                                      RETURN(FATFS_FILENAME_ERROR);
 422   4                              }else{
 423   4                                      g_szFileShortName[i] = '\0';  //²åÈë×Ö·û´®½áÊø±êÖ¾
 424   4                                      if(FATFSShortName(i) != FATFS_OPERATION_SUCCESS){ //½«8.3ÎÄ¼þÃû½øÐÐ×ª»»                          
 425   5                                              break;
 426   5                                      }
 427   4                                      if(szPath[i]=='\0'){ //ÊÇ·ñÎÄ¼þÄ©Î²
 428   5                                              if(FATFSDirOperation(DataCache, TRUE) == FATFS_OPERATION_SUCCESS){  //ÔÚÄ¿Â¼ÏîÖÐÆ¥ÅäÎÄ¼þ
 429   6                                                      RETURN(FATFS_OPERATION_SUCCESS);
 430   6                                              }else{
 431   6                                                      break;
 432   6                                              }
 433   5                                      }else{ //ÎÄ¼þ¼ÐÄ©Î²
 434   5                                              ++i;    //Ìø¹ý"\"
 435   5                                              if(FATFSDirOperation(DataCache, FALSE) == FATFS_OPERATION_SUCCESS){ //ÔÚÄ¿Â¼ÏîÖÐÆ¥ÅäÎÄ¼þ¼Ð
 436   6                                                      continue;  //½øÐÐÏÂÒ»´ÎµÄÎÄ¼þ/ÎÄ¼þ¼ÐÃû²éÕÒ
 437   6                                              }else{
 438   6                                                      break;
 439   6                                              }
 440   5                                      }
 441   4                              }
 442   3                      }
 443   2                      RETURN(FATFS_OPEN_FILE_FAILED);
 444   2              }
 445   1              RETURN(FATFS_FAT_REQUIRE_INITIAL);
 446   1      }
 447          
 448          
 449          
 450          
 451          /*************************************************************************
 452           º¯Êý£º FATFSDebugErrLvlMsg
 453           ÃèÊö£º Êä³öFAT_ERROR_LEVEL¶¨Òåµ½ÆÁÄ» ¶¨Òå_DEBUG_ÉúÐ§ RETURN ºê×Ô¶¯µ÷ÓÃ
 454          *************************************************************************/
 455          #ifdef _DEBUG_
              void FATFSDebugErrLvlMsg(BYTE ErrLvl){
                      switch(ErrLvl){
                              case FATFS_OPERATION_SUCCESS:
                                      PRINTF("²Ù×÷³É¹¦");
                                      break;
                              case FATFS_DEVICE_RESET_ERROR:
                                      PRINTF("SD¸´Î»´íÎó");
                                      break;
                              case FATFS_DEVICE_INITIAL_ERROR:
                                      PRINTF("³õÊ¼»¯³É¹¦");
                                      break;
                              case FATFS_READ_BPB_SEC_ERROR:
                                      PRINTF("¶ÁÈ¡BPBÉÈÇø´íÎó");
                                      break;
                              case FATFS_FATFS_NOT_SUPPORT:
                                      PRINTF("²»Ö§³ÖFATFS");
                                      break;
                              case FATFS_FS_NOT_SUPPORT:
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 9   

                                      PRINTF("FATFS_FS_NOT_SUPPORT");
                                      break;
                              case FATFS_OPERATION_MODE_ERROR:
                                      PRINTF("Ä£Ê½Ñ¡Ôñ´íÎó");
                                      break;
                              case FATFS_READ_FSI_SEC_ERROR:
                                      PRINTF("FATFS_READ_FSI_SEC_ERROR");
                                      break;
                              case FATFS_WRITE_FSI_SEC_ERROR:
                                      PRINTF("FATFS_WRITE_FSI_SEC_ERROR");
                                      break;
                              case FATFS_READ_DIR_ERROR:
                                      PRINTF("FATFS_READ_DIR_ERROR");
                                      break;
                              case FATFS_FAT_REQUIRE_INITIAL:
                                      PRINTF("FATFS_FAT_REQUIRE_INITIAL");
                                      break;
                              case FATFS_FILENAME_ERROR:
                                      PRINTF("FATFS_FILENAME_ERROR");
                                      break;
                              case FATFS_FILE_NOT_FOUND:
                                      PRINTF("FATFS_FILE_NOT_FOUND");
                                      break;
                              case FATFS_DIRECTORY_NOT_FOUND:
                                      PRINTF("FATFS_DIRECTORY_NOT_FOUND");
                                      break;
                              case FATFS_END_OF_FATDIR:
                                      PRINTF("FATFS_END_OF_FATDIR");
                                      break;
                              case FATFS_CACHE_NOMATCH:
                                      PRINTF("FATFS_CACHE_NOMATCH");
                                      break;
                              case FATFS_READ_FAT_ERROR:
                                      PRINTF("FATFS_READ_FAT_ERROR");
                                      break;
                              case FATFS_WRITE_FAT_ERROR:
                                      PRINTF("FATFS_WRITE_FAT_ERROR");
                                      break;
                              case FATFS_UPDATE_FSI_ERROR:
                                      PRINTF("FATFS_UPDATE_FSI_ERROR");
                                      break;
                              case FATFS_READ_SEC_ERROR:
                                      PRINTF("FATFS_READ_SEC_ERROR");
                                      break;
                              case FATFS_WRITE_SEC_ERROR:
                                      PRINTF("FATFS_WRITE_SEC_ERROR");
                                      break;
                              case FATFS_CLUS_SEC_ERROR:
                                      PRINTF("FATFS_CLUS_SEC_ERROR");
                                      break;
                              case FATFS_RETAINED_CLUSTER:
                                      PRINTF("FATFS_RETAINED_CLUSTER");
                                      break;
                              case FATFS_BAD_CLUSTER:
                                      PRINTF("FATFS_BAD_CLUSTER");
                                      break;
                              case FATFS_READ_BLOCK_OVERRANG:
                                      PRINTF("FATFS_READ_BLOCK_OVERRANG");
                                      break;
                              case FATFS_WRITE_BLOCK_OVERRANG:
                                      PRINTF("FATFS_WRITE_BLOCK_OVERRANG");
                                      break;
C51 COMPILER V9.00   FAT                                                                   08/19/2016 14:29:51 PAGE 10  

                              case FATFS_END_OF_FILE:
                                      PRINTF("FATFS_END_OF_FILE");
                                      break;
                              case FATFS_REQUIRE_EMPTYCLUS_ERROR:
                                      PRINTF("FATFS_REQUIRE_EMPTYCLUS_ERROR");
                                      break;
                              case FATFS_LAST_CLUSTER:
                                      PRINTF("FATFS_LAST_CLUSTER");
                                      break;
                              case FATFS_EMPTYCLUS_NOT_FOUND:
                                      PRINTF("FATFS_EMPTYCLUS_NOT_FOUND");
                                      break;
                              case FATFS_CACHE_NOEMPTYDIR:
                                      PRINTF("FATFS_CACHE_NOEMPTYDIR");
                                      break;
                              case FATFS_FOUND_EMPTYCLUS_ERROR:
                                      PRINTF("FATFS_FOUND_EMPTYCLUS_ERROR");
                                      break;
                              case FATFS_NAME_EXT_TOO_LONG:
                                      PRINTF("ºó×ºÌ«³¤");
                                      break;
                              case FATFS_NAME_NAME_TOO_LONG:
                                      PRINTF("ÃüÃûÌ«³¤");
                                      break;
                              case FATFS_OPEN_FILE_FAILED:
                                      PRINTF("´ò¿ªÎÄ¼þ´íÎó");
                                      break;
                      }
              }
              #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3576    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     13      32
   DATA SIZE        =     42    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
